version: '3.8'

services:
  redis-leader:
    image: redis
    command: redis-server --appendonly yes --notify-keyspace-events KEA

  redis-follower-1:
    image: redis
    command: redis-server --slaveof redis-leader 6379
    depends_on:
      - redis-leader

  redis-follower-2:
    image: redis
    command: redis-server --slaveof redis-leader 6379
    depends_on:
      - redis-leader

  redis-follower-3:
    image: redis
    command: redis-server --slaveof redis-leader 6379
    depends_on:
      - redis-leader

  redis-proxy:
    build: ./redis-proxy
    depends_on:
      - redis-leader
      - redis-follower-1
      - redis-follower-2
      - redis-follower-3
    ports:
      - "6478:6379"

  fastapi-server-1:
    build: ./like-service
    depends_on:
      - redis-proxy
      - postgres-db
    environment:
      - REDIS_HOST=redis-proxy
      - REDIS_PORT=6379
      - DATABASE_URL=postgresql://likesdb:likesdb@postgres-db/likesdb

  fastapi-server-2:
    build: ./like-service
    depends_on:
      - redis-proxy
      - postgres-db
    environment:
      - REDIS_HOST=redis-proxy
      - REDIS_PORT=6379
      - DATABASE_URL=postgresql://likesdb:likesdb@postgres-db/likesdb

  fastapi-server-3:
    build: ./like-service
    depends_on:
      - redis-proxy
      - postgres-db
    environment:
      - REDIS_HOST=redis-proxy
      - REDIS_PORT=6379
      - DATABASE_URL=postgresql://likesdb:likesdb@postgres-db/likesdb

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      - fastapi-server-1
      - fastapi-server-2
      - fastapi-server-3

  postgres-db:
    image: postgres:latest
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - POSTGRES_DB=likesdb
      - POSTGRES_USER=likesdb
      - POSTGRES_PASSWORD=likesdb
    ports:
      - "5663:5432"

  rabbitmq:
      image: rabbitmq:3-management-alpine
      container_name: 'rabbitmq'
      ports:
          - 5672:5672  # AMQP
          - 15672:15672  # Web UI
      volumes:
        - ~/.docker-conf/rabbitmq/data/:/var/lib/rabbitmq/
        - ~/.docker-conf/rabbitmq/log/:/var/log/rabbitmq